<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="tt">Cart</title>
    <link rel="stylesheet" href="/css/Store-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin="anonymous" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    .advir{
        display: none;
        position: fixed;
        left: 45%;
        top: 5%;
        transform: translate(-50%, 5%);
        border: 3px solid #999999;
        z-index: 9;
        background-color: #fff;
        padding: 100px;
        }
        .advir #address, #city, #postal,#mobile{
            border-radius: 5px;
            margin-top: 50px;
            position: relative;
            background-color: rgb(158, 158, 158);
        }
        #address, #city, #postal,#mobile{
            margin-left: 40px;
        }
</style>
</head>
<body>

    <div class="header">
        
   
      <div class="container">
        <div class="nav-bar">
            <div class="logo" id="logo"></div>
            <nav>
                <ul id="menuItem">
                <li><a href="" id="home">Home</a></li>
            </ul>
            </nav>
            <img onclick="openCart()" src="https://firebasestorage.googleapis.com/v0/b/estoreplatform-2d6f7.appspot.com/o/Our-projects-photos%2Fcart.png?alt=media&token=5bb165c6-9b39-481e-9218-706c9e845484" style="height: 30px; width: 30px; cursor: pointer;"><span class="cart">0</span>
            <img class="menu-icon" onclick="menutogg()" src="https://firebasestorage.googleapis.com/v0/b/estoreplatform-2d6f7.appspot.com/o/Our-projects-photos%2Fmenu.png?alt=media&token=ff17647b-5d84-400e-a86d-65affa485e79">
        </div>

        <div class="advir" id="closeSubmitWin" style="display: none; z-index: 1; border-radius: 9px;">
            <h2>Address Info & Submit Order</h2>
            <label>Address</label>
      <input type="text" name="address" id="address" required><br>
      <label>Which city</label>
      <input type="text" name="city" id="city" required><br>
      <label>Postal Code</label>
      <input type="text" name="postal" id="postal" required><br>
      <label>Mobile Number</label>
      <button type="submit" class="btn" onclick="submitOrder()" >Submit</button>
      <button type="submit" class="btn" onclick="cancel()" >cancel</button>

        </div>
    </div>

    <div class="small-container cart-page">
        <table class="cartX">
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Subtotal</th>
            </tr>
                   </table>

        <div class="total-price">
            <table > 
                <tr class='cart-total'>
                    <td>Total</td>
                    <td class='tot'></td>
                </tr>
            </table>
            
        </div>
        <button class="btn subtot" onclick="openSubmit()">Submit</button>
    </div>

   <footer>
        <div class="container">
        <div class="row">
            <div class="footer-col-1">
                <h3></h3>
                <p>&copy; 2021 <span class="logo"><a href="/">eStore Platform</a></span> All rights reserved </p><br>
                <i class="fab fa-cc-visa" style="font-size: 30px;"></i>
            </div>
            <div class="footer-col-2">
                <h3>You can find us on</h3>
                <ul>
                    <li><i class="fab fa-twitter"></i><a href="#">Twitter</a></li>
                    <li><i class="fab fa-instagram"></i><a href="#">Instagram</a></li>
                    <li><i class="fab fa-facebook"></i> <a href="#">Facebook</a></li>
                </ul>
            </div>
        </div>
    </div>
    </footer>
    
<!-- js for toggle menu -->
<script>
     function openSubmit(){
        if(localStorage.getItem('cartNumbers') === '0'){
                alert('Cart is Empty!  try add some items in it')    
        }
        else {

            document.getElementById('closeSubmitWin').style.display = 'block';
        }
        
    }
    
    function cancel() {
        document.getElementById('closeSubmitWin').style.display = 'none';
       
    }

function openCart(){
    let url = window.location.href
        window.location = url;
}
    var menutm = document.getElementById('menuItem');
    menutm.style.maxHeight = '0px';
    
    function menutogg(){
        if(menutm.style.maxHeight == '0px'){
            menutm.style.maxHeight = '200px';
        }
        else{
            menutm.style.maxHeight = '0px';
        }
    }
    
    </script>
    
        <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>
    
    <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-firestore.js"></script>
    
        <script >
    
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    var firebaseConfig = {
      apiKey: "AIzaSyCMVlN5Jig5hnH5It1GWOA0kILH-EL3Exc",
        authDomain: "estoreplatform-2d6f7.firebaseapp.com",
        databaseURL: "https://estoreplatform-2d6f7-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "estoreplatform-2d6f7",
        storageBucket: "estoreplatform-2d6f7.appspot.com",
        messagingSenderId: "1004459441040",
        appId: "1:1004459441040:web:05cd7d03073c8549d81115",
        measurementId: "G-2V5D2MQ7R3"
    };
    
      firebase.initializeApp(firebaseConfig);
    
      
      var x = window.location.href;
      var y = document.URL;
      
      x = x.split("/");
      y = y.split('/');
      
      console.log(x);
    const logotxt = document.getElementById('logo');
    const hometxt = document.getElementById('home');
    
  
    
        const change = function UserRet(logo, home){
    
    
               logotxt.innerHTML = logo;
               hometxt.setAttribute('href', home);
    
       }
       firebase.firestore().collection('client-users').get().then(snapshot => {
    
    snapshot.docs.map(doc => {
      
        if(doc.data().store == x[3]){
        
        logotxt.innerHTML = doc.data().store;
        if(sessionStorage.getItem('email')){
            hometxt.setAttribute('href', '/'+doc.data().store+'/home');
        } else {
            hometxt.setAttribute('href', '/'+doc.data().store+'/');
        }
        
        //signuptxt.setAttribute('href', '/' + doc.data().store + '/signupuser');
        signintxt.setAttribute('href', '/' + doc.data().store + '/login');
        document.getElementById('tt').innerHTML = doc.data().store;
    }
    
    });
    });
    
           
    
    
           
          
        firebase.firestore().collection('products').doc(x[3]).collection('products-store').get().then(snapshot => {
            let products = [];
      snapshot.docs.map(doc => {
        
      
      
      var arr = firebase.firestore().collection('products').doc(x[3]).collection('products-store').get().then(snapshot => {
          
         snapshot.docs.map(doc => {
                products.push({
                    name: doc.data().productName,
                    price: doc.data().productPrice,
                    inCart: 0
                });
         })               
        })
         
         
      
                 
       
          
            
     
      });
    
      let carts = document.querySelectorAll('.add-cart')
            console.log(carts.length)
      for(let i=0; i<carts.length; i++) {
        carts[i].addEventListener('click', () => {
            cartNumbers(products[i]);
            totalCost(products[i]);
        });
    }
      
    });
    
    function onLoadCartNumbers() {
       
        let productNumbers = localStorage.getItem('cartNumbers');
    
        if(productNumbers){
            document.querySelector('.cart').textContent = productNumbers;
        }
    }
    
    function cartNumbers(product) {
    let productNumbers = localStorage.getItem('cartNumbers');
    
        productNumbers = parseInt(productNumbers);
    
        if( productNumbers ){
             localStorage.setItem('cartNumbers', productNumbers + 1);
             document.querySelector('.cart').textContent = productNumbers + 1;
        } else {
            localStorage.setItem('cartNumbers', 1);
            document.querySelector('.cart').textContent = 1;
        }
    
       setItems(product);
    }
    
    function setItems(product) {
        let cartItems = localStorage.getItem('productsInCart');
        cartItems = JSON.parse(cartItems);
    
        if(cartItems != null){
            if(cartItems[product.name] == undefined){
                cartItems = {
                    ...cartItems,
                    [product.name]: product
                }
          }
          cartItems[product.name].inCart += 1;
        } else {
             product.inCart = 1;
        cartItems = {
            [product.name]: product
        }
    }
       
        localStorage.setItem('productsInCart', JSON.stringify(cartItems));
    }
    
    function totalCost(product) {
        let cartCost = localStorage.getItem('totalCost');
        console.log('My Cart Cost is: ', cartCost);
    
        if(cartCost != null) {
            cartCost = parseInt(cartCost);
            product.price = parseInt(product.price);
            localStorage.setItem('totalCost', cartCost + product.price);
        } else {
            localStorage.setItem('totalCost', product.price);
        }
    }
    
    function displayCart() {
           let cartItems = localStorage.getItem('productsInCart');
           let cartTot = localStorage.getItem('totalCost');
             cartItems = JSON.parse(cartItems);
           let productCont = document.querySelector('.cartX');
           let cartTotal = document.querySelector('.cart-total');

           console.log(cartItems);
            if(cartItems && productCont) {
                productCont.innerHTML;
                Object.values(cartItems).map(item => {
            var tr = document.createElement('tr');
            var div = document.createElement('div');
            var td = document.createElement('td');
            var divInside = document.createElement('div');
            div.classList.add('cart-info');
            tr.setAttribute('id', item.name);
            var imgProduct = document.createElement('img');
            var name = document.createElement('p');
            var price = document.createElement('small');
            var qunt = document.createElement('td');
            var subtotal =document.createElement('td');
            var delPrdct = document.createElement('button');
            var br = document.createElement('br')
            delPrdct.classList.add(item.name);
            delPrdct.classList.add('btn');
            delPrdct.innerHTML = 'remove';
  
            delPrdct.onclick = function(e)  {
                document.getElementById(item.name).innerHTML = '';
                                    
                                         
                if(cartItems[item.name].name === item.name) {
                    var qun = item.inCart;
                    delete cartItems[item.name];
                    console.log(cartItems);
                    cartItems = JSON.stringify(cartItems);
                    localStorage.setItem('productsInCart', cartItems);
                    let productNumbers = localStorage.getItem('cartNumbers');
                        productNumbers = parseInt(productNumbers);
                        productNumbers = productNumbers - qun;
                        localStorage.setItem('cartNumbers', productNumbers);
                        document.querySelector('.cart').textContent = productNumbers;
                }
                                    
            }
            
                    var imgURL = firebase.storage().ref('products/'+x[3]+'/'+item.name+'.jpg').getDownloadURL();
                    var _getUrlImg;
                    imgURL.then((url) => {
                        imgProduct.src = url;
                        div.firstChild.before(imgProduct);
                    });
                    
                    divInside.appendChild(name).innerHTML = item.name;
                    divInside.appendChild(price).innerHTML = 'Price: $'+item.price;
                    divInside.appendChild(br);
                    divInside.appendChild(delPrdct);
                    div.appendChild(divInside);
                    td.appendChild(div);
                    tr.appendChild(td);
                    tr.appendChild(qunt).innerHTML = item.inCart;
                    tr.appendChild(subtotal).innerHTML = '$'+item.price*item.inCart+'.00';
                    productCont.appendChild(tr);
                });

                var cart_total = document.querySelector('.tot');
                cart_total.innerHTML = '$'+localStorage.getItem('totalCost')+'.00';
                    
            }

            
    }

    function submitOrder() {
        var Eemail;
        let cartItems = JSON.parse(localStorage.getItem('productsInCart')) ;
        var orderNumber = new Date().valueOf();
        Eemail = sessionStorage.getItem('email');
        if(Eemail) {
            firebase.firestore().collection('products').doc(x[3]).collection('products-store').get().then(snap => {
           snap.docs.map(doc => {
               if(doc.data().productQuantity != 0){
                     Object.values(cartItems).map(item => {
                    if(doc.data().productName === item.name){
                        var totQun = doc.data().productQuantity - item.inCart;
                        firebase.firestore().collection('products').doc(x[3]).collection('products-store').doc(doc.id).update({
                    productQuantity: totQun
                })
                    }
                
            })
                            document.getElementById('closeSubmitWin').style.display = 'none';

                firebase.firestore().collection('client-users').doc(x[3]).collection('Orders').add({
                    createAt: new Date().toISOString(),
                    email: Eemail,
                    totalCost: localStorage.getItem('totalCost'),
                    numberOfItems: localStorage.getItem('cartNumbers'),
                    product: localStorage.getItem('productsInCart'),
                    orderNumber: orderNumber
                }).then(() => {
                    alert('Order is submited, Thank you for order, please visit us again!');
                    if(Eemail){
                        var urlUnSigned = x[0].split('cart');
                        window.location = urlUnSigned[0]+'home';
                    }
                    
                    localStorage.clear();
                    
                });

               } else {
                   alert('some item is out of Stock!');
               }
           
        })
       })
      //  console.log(typeof Eemail);
      
       

        } else {
            alert('you have to sign in before');
            var urlUnSigned = x[0].split('cart');
               window.location = urlUnSigned[0]+'login';
        }
       
    }

    onLoadCartNumbers();
    displayCart();



        </script>
     
</body>
</html>